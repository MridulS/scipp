[tox]
minversion = 3.15
isolated_build = True
envlist = lib,test

[testenv]
depends = lib
skip_install = true
setenv = PYTHONPATH = {toxinidir}/install
# TODO change to 3.8
basepython = python3.9

[testenv:lib]
depends =
deps = -r requirements/build.txt
commands =
  cmake --preset ci-linux
  cmake --build --preset build
  ctest --preset test

[testenv:test]
depends = lib
deps = -r requirements/test.txt
commands = python -m pytest -n auto -v tests

[testenv:docs]
depends = lib
deps = -r requirements/docs.txt
allowlist_externals=find
commands =
  python -m sphinx -j2 -v -b html -d doctrees docs html
  python -m sphinx -j2 -v -b doctest -d doctrees docs html
  python -m sphinx -j2 -v -b linkcheck -d doctrees docs html
  find html -type f -name "*.ipynb" -not -path "html/_sources/*" -delete

[testenv:static]
description = Code formatting and static analysis
deps = -r requirements/static.txt
allowlist_externals=find
commands =
  find lib -type f -regex '.*\.\(cpp\|h\|tcc\)' -exec clang-format -i \{\} +
  find lib CMakeLists.txt -type f -name CMakeLists.txt -or -name '*.cmake' -not -path './lib/cmake/sanitizers-cmake/*' -exec cmake-format -i \{\} +
  nbstripout --extra-keys 'metadata.language_info.version cell.metadata.jp-MarkdownHeadingCollapsed' --strip-empty-cells .
  yapf --recursive --in-place --exclude .tox .
  flake8 .
